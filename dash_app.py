# app.py
import streamlit as st
import pandas as pd
import plotly.express as px

st.set_page_config(page_title="Utility Benchmark ‚Äî –¥–∞—à–±–æ—Ä–¥", page_icon="üè†", layout="wide")

# ------------------------
# –û–ë–©–ò–ï –ù–ê–°–¢–†–û–ô–ö–ò
# ------------------------
SCENARIOS = {"–≠–∫–æ–Ω–æ–º–Ω—ã–π": 0.85, "–°—Ä–µ–¥–Ω–∏–π": 1.0, "–†–∞—Å—Ç–æ—á–∏—Ç–µ–ª—å–Ω—ã–π": 1.25}
HOUSE_COEFS = {
    "–ù–æ–≤—ã–π": {"heating": 1.0, "electricity": 1.0},
    "–°—Ä–µ–¥–Ω–∏–π": {"heating": 1.05, "electricity": 1.05},
    "–°—Ç–∞—Ä—ã–π": {"heating": 1.1, "electricity": 1.05},
}
REALISM_UPLIFT = 1.07
MONTH_NAMES = ["–Ø–Ω–≤", "–§–µ–≤", "–ú–∞—Ä", "–ê–ø—Ä", "–ú–∞–π", "–ò—é–Ω", "–ò—é–ª", "–ê–≤–≥", "–°–µ–Ω", "–û–∫—Ç", "–ù–æ—è", "–î–µ–∫"]

# ----------------------------------------------------
# --- –î–ê–ù–ù–´–ï –ò –õ–û–ì–ò–ö–ê –î–õ–Ø –ú–ò–ù–°–ö–ê (–ë–ï–õ–ê–†–£–°–¨) ---
# ----------------------------------------------------
MINSK_CATEGORIES = ["–≠–ª–µ–∫—Ç—Ä–æ—ç–Ω–µ—Ä–≥–∏—è", "–í–æ–¥–∞", "–ö–∞–Ω–∞–ª–∏–∑–∞—Ü–∏—è", "–û—Ç–æ–ø–ª–µ–Ω–∏–µ", "–§–∏–∫—Å. –ø–ª–∞—Ç–µ–∂–∏"]
MINSK_HEATING_MONTHS = [1, 2, 3, 4, 10, 11, 12]

MINSK_DEFAULT_COEFFS = {
    "elec_base_kWh": 60.0, "elec_per_person_kWh": 75.0, "elec_per_m2_kWh": 0.5,
    "water_per_person_m3": 4.5, "hot_water_fraction": 0.6,
    "heating_Gcal_per_m2_season_mid": 0.15, "heating_season_months": 7.0
}

MINSK_TARIFFS = {
    "electricity_BYN_per_kWh_full": 0.2969, "electricity_BYN_per_kWh_subsidy": 0.2412,
    "heating_BYN_per_Gcal_full": 134.94, "heating_BYN_per_Gcal_subsidy": 24.7187,
    "water_BYN_per_m3": 1.7858, "sewage_BYN_per_m3": 0.9586, "fixed_fees_BYN": 5.0
}

def calculate_volumes_minsk(area_m2, occupants, behavior_factor, month=1):
    coeffs = MINSK_DEFAULT_COEFFS
    elec = (coeffs["elec_base_kWh"] + coeffs["elec_per_person_kWh"] * occupants +
            coeffs["elec_per_m2_kWh"] * area_m2) * behavior_factor
    water = coeffs["water_per_person_m3"] * occupants * behavior_factor
    sewage = water
    heat_monthly = 0.0
    if month in MINSK_HEATING_MONTHS:
        G_mid = coeffs["heating_Gcal_per_m2_season_mid"] * area_m2
        heat_monthly = G_mid / coeffs["heating_season_months"]
    return {
        "–≠–ª–µ–∫—Ç—Ä–æ—ç–Ω–µ—Ä–≥–∏—è": round(elec, 1), "–í–æ–¥–∞": round(water, 2),
        "–ö–∞–Ω–∞–ª–∏–∑–∞—Ü–∏—è": round(sewage, 2), "–û—Ç–æ–ø–ª–µ–Ω–∏–µ": round(heat_monthly, 3)
    }

def calculate_costs_minsk(volumes, tariffs, area_m2, occupants, floor=1, has_elevator=True):
    elec_cost = volumes["–≠–ª–µ–∫—Ç—Ä–æ—ç–Ω–µ—Ä–≥–∏—è"] * tariffs["electricity_BYN_per_kWh_subsidy"]
    water_cost = volumes["–í–æ–¥–∞"] * tariffs["water_BYN_per_m3"]
    sewage_cost = volumes["–ö–∞–Ω–∞–ª–∏–∑–∞—Ü–∏—è"] * tariffs["sewage_BYN_per_m3"]
    heat_cost = volumes["–û—Ç–æ–ø–ª–µ–Ω–∏–µ"] * tariffs["heating_BYN_per_Gcal_subsidy"]

    fixed = (area_m2 * 0.0388) + (area_m2 * 0.0249) + (0.2092 * occupants) + (area_m2 * 0.05)
    if has_elevator and floor >= 2:
        fixed += 0.88 * occupants

    costs = {
        "–≠–ª–µ–∫—Ç—Ä–æ—ç–Ω–µ—Ä–≥–∏—è": round(elec_cost, 2), "–í–æ–¥–∞": round(water_cost, 2),
        "–ö–∞–Ω–∞–ª–∏–∑–∞—Ü–∏—è": round(sewage_cost, 2), "–û—Ç–æ–ø–ª–µ–Ω–∏–µ": round(heat_cost, 2),
        "–§–∏–∫—Å. –ø–ª–∞—Ç–µ–∂–∏": round(fixed, 2)
    }
    costs["–ò—Ç–æ–≥–æ"] = round(sum(costs.values()), 2)
    return costs

# ----------------------------------------------------
# --- –î–ê–ù–ù–´–ï –ò –õ–û–ì–ò–ö–ê –î–õ–Ø –õ–ò–ú–ê–°–û–õ–ê (–ö–ò–ü–†) ---
# ----------------------------------------------------
LIMASSOL_CATEGORIES = ["–ê—Ä–µ–Ω–¥–∞", "–≠–ª–µ–∫—Ç—Ä–æ—ç–Ω–µ—Ä–≥–∏—è", "–í–æ–¥–∞", "–ò–Ω—Ç–µ—Ä–Ω–µ—Ç", "–¢–µ–ª–µ—Ñ–æ–Ω", "IPTV", "–û–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ"]

LIMASSOL_TARIFFS = {
    "rent": 4600,
    "electricity_history": {
        1: 0.242, 2: 0.242, 3: 0.242, 4: 0.242, 5: 0.2705, 6: 0.2705,
        7: 0.2661, 8: 0.2661, 9: 0.2661, 10: 0.2661, 11: 0.2661, 12: 0.2661
    },
    "vat_electricity": 0.19, "water_base": 22,
    "water_tiers": {40: 0.9, 80: 1.43, 120: 2.45, float('inf'): 5.0},
    "vat_water": 0.05, "internet": 20, "phone": 20, "iptv": 10,
    "vat_services": 0.19, "service_min": 45, "service_max": 125,
}

def calculate_water_cost_limassol(volume_m3):
    tariffs = LIMASSOL_TARIFFS
    cost = tariffs["water_base"]
    remaining_volume = volume_m3
    tier_limits = sorted(tariffs["water_tiers"].keys())
    last_limit = 0
    for limit in tier_limits:
        if remaining_volume <= 0: break
        vol_in_tier = min(remaining_volume, limit - last_limit)
        cost += vol_in_tier * tariffs["water_tiers"][limit]
        remaining_volume -= vol_in_tier
        last_limit = limit
    return cost * (1 + tariffs["vat_water"])

def calculate_costs_limassol(volumes, month):
    tariffs = LIMASSOL_TARIFFS
    elec_tariff = tariffs["electricity_history"].get(month, 0.2661)
    costs = {
        "–ê—Ä–µ–Ω–¥–∞": tariffs["rent"],
        "–≠–ª–µ–∫—Ç—Ä–æ—ç–Ω–µ—Ä–≥–∏—è": round(volumes["–≠–ª–µ–∫—Ç—Ä–æ—ç–Ω–µ—Ä–≥–∏—è"] * elec_tariff * (1 + tariffs["vat_electricity"]), 2),
        "–í–æ–¥–∞": round(calculate_water_cost_limassol(volumes["–í–æ–¥–∞"]), 2),
        "–ò–Ω—Ç–µ—Ä–Ω–µ—Ç": round(tariffs["internet"] * (1 + tariffs["vat_services"]), 2),
        "–¢–µ–ª–µ—Ñ–æ–Ω": round(tariffs["phone"] * (1 + tariffs["vat_services"]), 2),
        "IPTV": round(tariffs["iptv"] * (1 + tariffs["vat_services"]), 2),
        "–û–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ": round(((tariffs["service_min"] + tariffs["service_max"]) / 2) * (1 + tariffs["vat_services"]), 2)
    }
    costs["–ò—Ç–æ–≥–æ"] = round(sum(costs.values()), 2)
    return costs

# ------------------------
# Sidebar: –æ–±—â–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
# ------------------------
st.sidebar.header("üìç –í—ã–±–æ—Ä –≥–æ—Ä–æ–¥–∞ –∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã")
selected_city = st.sidebar.selectbox("–ì–æ—Ä–æ–¥", ["–ú–∏–Ω—Å–∫", "–õ–∏–º–∞—Å–æ–ª"], key='city_select')
month = st.sidebar.selectbox("–ú–µ—Å—è—Ü", list(range(1, 13)), format_func=lambda x: MONTH_NAMES[x - 1], key='month_select')

# ------------------------
# –ì–õ–ê–í–ù–û–ï –û–ö–ù–û
# ------------------------
if selected_city == "–ú–∏–Ω—Å–∫":
    st.title("üè† –ö–æ–º–º—É–Ω–∞–ª—å–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏: –ú–∏–Ω—Å–∫")
    
    st.sidebar.header("–ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Å–µ–º—å–∏ (–ú–∏–Ω—Å–∫)")
    area_m2 = st.sidebar.number_input("–ü–ª–æ—â–∞–¥—å, –º¬≤", 10.0, 500.0, 90.0, key='minsk_area')
    adults = st.sidebar.number_input("–í–∑—Ä–æ—Å–ª—ã–µ", 0, 10, 2, key='minsk_adults')
    children = st.sidebar.number_input("–î–µ—Ç–∏", 0, 10, 2, key='minsk_children')
    occupants = adults + children
    
    scenario = st.sidebar.selectbox("–°—Ü–µ–Ω–∞—Ä–∏–π –ø–æ–≤–µ–¥–µ–Ω–∏—è", list(SCENARIOS.keys()), index=1, key='minsk_scenario')
    behavior_factor = SCENARIOS[scenario]
    house_category = st.sidebar.selectbox("–ö–∞—Ç–µ–≥–æ—Ä–∏—è –¥–æ–º–∞", list(HOUSE_COEFS.keys()), index=1, key='minsk_house_type')
    st.sidebar.markdown("---")
    use_subsidy = st.sidebar.checkbox("–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ª—å–≥–æ—Ç–Ω—ã–π —Ç–∞—Ä–∏—Ñ", key='minsk_subsidy_check')
    subsidy_rate = st.sidebar.slider("–î–æ–ª—è –æ—Ç –ø–æ–ª–Ω–æ–≥–æ —Ç–∞—Ä–∏—Ñ–∞", 0.0, 1.0, 0.2, 0.05, key='minsk_subsidy_slider') if use_subsidy else 1.0

    st.header("üìä –í–≤–µ–¥–∏—Ç–µ –≤–∞—à–∏ —Ä–µ–∞–ª—å–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã –∑–∞ –º–µ—Å—è—Ü (BYN)")
    with st.expander("–ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–ª—è –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –≤–≤–æ–¥–∞"):
        user_real = {cat: st.number_input(f"{cat} BYN", min_value=0.0, value=0.0, step=1.0, format="%.2f", key=f'minsk_input_{cat}') for cat in MINSK_CATEGORIES}
    user_real["–ò—Ç–æ–≥–æ"] = sum(user_real.values())

    ideal_vol = calculate_volumes_minsk(area_m2, occupants, 1.0, month=month)
    ideal_costs = calculate_costs_minsk(ideal_vol, MINSK_TARIFFS, area_m2, occupants)
    neighbor_vol = calculate_volumes_minsk(area_m2, occupants, behavior_factor, month=month)
    neighbor_costs_minsk = calculate_costs_minsk(neighbor_vol, MINSK_TARIFFS, area_m2, occupants)
    neighbor_costs = {k: v * REALISM_UPLIFT for k, v in neighbor_costs_minsk.items()}
    neighbor_costs["–ò—Ç–æ–≥–æ"] = sum(neighbor_costs.values())

    st.header("üè† –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ä–∞—Å—Ö–æ–¥–æ–≤ (–ú–∏–Ω—Å–∫)")
    # ... –æ—Å—Ç–∞–ª—å–Ω–∞—è —á–∞—Å—Ç—å –∫–æ–¥–∞ –¥–ª—è –ú–∏–Ω—Å–∫–∞ –Ω–µ –º–µ–Ω—è–µ—Ç—Å—è ...

elif selected_city == "–õ–∏–º–∞—Å–æ–ª":
    st.title("üè† –ö–æ–º–º—É–Ω–∞–ª—å–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏: –õ–∏–º–∞—Å–æ–ª")
    
    st.header("üìä –í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ –∏ —Ä–∞—Å—Ö–æ–¥—ã –∑–∞ –º–µ—Å—è—Ü")
    col1, col2 = st.columns(2)
    with col1:
        st.subheader("–ü–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤")
        user_consumption = {
            "–≠–ª–µ–∫—Ç—Ä–æ—ç–Ω–µ—Ä–≥–∏—è": st.number_input("–≠–ª–µ–∫—Ç—Ä–æ—ç–Ω–µ—Ä–≥–∏—è, –∫–í—Ç¬∑—á", min_value=0.0, value=1048.0, step=10.0, key='limassol_consum_elec'),
            "–í–æ–¥–∞": st.number_input("–í–æ–¥–∞, –º¬≥", min_value=0.0, value=25.2, step=1.0, key='limassol_consum_water'),
        }
    with col2:
        st.subheader("–§–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Ä–∞—Å—Ö–æ–¥—ã (‚Ç¨)")
        user_real_costs = {
            cat: st.number_input(f"{cat} ‚Ç¨", min_value=0.0, value=0.0, step=5.0, key=f'limassol_costs_{cat}') for cat in LIMASSOL_CATEGORIES
        }
    user_real_costs["–ò—Ç–æ–≥–æ"] = sum(user_real_costs.values())

    calculated_costs = calculate_costs_limassol(user_consumption, month)

    st.header("üè† –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ä–∞—Å—á–µ—Ç–Ω—ã—Ö –∏ —Ä–µ–∞–ª—å–Ω—ã—Ö —Ä–∞—Å—Ö–æ–¥–æ–≤ (‚Ç¨)")
    # ... –æ—Å—Ç–∞–ª—å–Ω–∞—è —á–∞—Å—Ç—å –∫–æ–¥–∞ –¥–ª—è –õ–∏–º–∞—Å–æ–ª–∞ –Ω–µ –º–µ–Ω—è–µ—Ç—Å—è ...

# (–í–µ—Å—å –æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ç–∞–±–ª–∏—Ü –∏ –≥—Ä–∞—Ñ–∏–∫–æ–≤ –æ—Å—Ç–∞–µ—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
# –Ø –Ω–µ —Å—Ç–∞–ª –µ–≥–æ —Å—é–¥–∞ –∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å, —á—Ç–æ–±—ã –Ω–µ –∑–∞–≥—Ä–æ–º–æ–∂–¥–∞—Ç—å –æ—Ç–≤–µ—Ç, 
# –Ω–æ –æ–Ω –¥–æ–ª–∂–µ–Ω –æ—Å—Ç–∞—Ç—å—Å—è –≤ –≤–∞—à–µ–º —Ñ–∞–π–ª–µ.
# –ü—Ä–æ—Å—Ç–æ –≤—Å—Ç–∞–≤—å—Ç–µ —ç—Ç–æ—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –∫–æ–¥ –¥–æ –Ω–∞—á–∞–ª–∞ —Å–µ–∫—Ü–∏–∏
# —Å st.header("üè† –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ä–∞—Å—Ö–æ–¥–æ–≤ (–ú–∏–Ω—Å–∫)") 
# –∏ –¥–æ st.header("üè† –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ä–∞—Å—á–µ—Ç–Ω—ã—Ö –∏ —Ä–µ–∞–ª—å–Ω—ã—Ö —Ä–∞—Å—Ö–æ–¥–æ–≤ (‚Ç¨)")
